# 规范

## 数据库设计规范

* 数据库不应该创建过多的表
  在wiretiger引擎中，每个集合都需要创建多个文件夹来保存元数据、数据及索引，磁盘上过多的小文件会导致性能下降。  
  建议单个数据库的表个数控制在100个以内，整个数据库实例的表数量控制在2000个以内。
* 数据库最好以db开头，不能包含除_以外的特殊字符，所有字母全部小写，数据库名不超过64个字符。
* 集合名最好以t_开头，不能包含除_以外的特殊字符，集合名不超过120个字符。

## 索引规范

* 创建索引时要带上background参数，特别是生产环境  
  MongoDB 4.2及之前版本，createIndex()命令默认是foreground模式，这种模式下创建索引会阻塞数据库的所有操作，会造成业务中。示例： db.users.createIndex({user_id}:1}, {unique:true, background:true})
* 排序字段需要创建索引，避免业务大量在内存中排序造成数据库OOM(Out Of Memory)  
  * MongoDB 4.2及之前的版本，一条查询默认只允许使用32MB内存进行排序，如果超出会提示Sort operation used more than the maximum 33554432 bytes of RAM错误，通过执行db.adminCommand({setParameter : 1,"internalQueryExecMaxBlockingSortBytes" : 104857600})调整内存。
  * 生产环境禁止调整，这样会增大数据库OOM的概率。建索引时就应该考滤加入排序字段。
  * MongoDB 4.4版本虽然提供了磁盘排序的选项来避免排序消耗大量内存，但建议最好使用索引排序。
* 一个表不宜创建过多的索引
  MongoDB插入每条数据的时候同时需要写索引。索引越多，写入数据时就要花费更多的代价。单个表索引建议不超过10个。
* 最好定期清理无用的索引  
  索引在写操作时会带来额外的资源消耗，所以需要尽量精简索引。  
  MongoDB 4.4版本之后，可使用hidden index先隐藏掉无用的索引，隐藏后业务确认正常后再删除索引。
* 按照最左匹配原则，如果单字段索引已经被复合索引包含，应该删除，因为额外的索引会造成写操作时的性能浪费。
* 尽量避免$ne/$nin等操作，和其他数据库(如MySQL)一样，不等于及not in类的操作无法有效利用索引，应该避免使用。
* 考滤使用区分度大的字段建立索引  
  如果索引字段区分度较小，查询扫描的行数依然会比较多，查询效率较低，对数据库负载影响较大。

## 数据库操作规范

* 操作命令应该使用explain()确认执行计划  
  上线执行操作命令前需要用explain()确认执行计划是否符合预期，否则上线可能会引起故障。
* 生产环境禁止关闭鉴权  
  关闭鉴权会将数据库暴露给所有人，特别是数据库服务器开通了外网。
* admin,local库不能存储业务数据  
  admin库读写时会加db锁，影响性能;local库只会保存到本地，不会复制到从节点，如果发生主人切换会丢失数据。
* 禁止执行db.dropDatabase()命令后再创建同名的db  
  * MongoDB 4.0及之前的版本，官方文档要求删除db并创建同名db后，业务读写数据前需要在所有mongos节点上执行重启或flushRouterConfig命令。
  * MongoDB 4.2及之后的版本，需要对所有的mongos和mongod节点重启或执行flushRouterConfig命令。  
    所以禁止在业务代码中直接执行db.dropDatabase()命令后再创建同名的db。
* 高并发高性能场景，禁止过度使用in和or  
  in 或者or 条件语句在数据库底层需要转换成多次查询，过多的in和or操作在高并发高性能场景，会严重影响请求的响应时延及数据库负载。
